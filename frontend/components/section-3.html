<div class="section3-root">
  <style>
    .section3-root {
      width: 100%;
      height: 100%;
      box-sizing: border-box;
      background: var(--section-bg, #2b402f);
      color: var(--section-accent, #303539);
      font-family: var(--section-font, "Times New Roman", Times, serif);
      padding: var(--section-padding, 1rem);
      overflow: hidden;
      display: flex;
    }

    .section3-root .section-block.charcoal-set-in {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    .section3-root .container {
      width: min(1100px, 100% - 2rem);
      margin: 0 auto;
      height: 100%;
    }

    .section3-root .weather-container {
      height: 100%;
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.5fr);
      gap: 1.25rem;
    }

    .section3-root .weather-left {
      background: rgba(0, 0, 0, 0.4);
      border-radius: 0.9rem;
      padding: 0.9rem 1.1rem;
      color: #ffffff;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      box-sizing: border-box;
    }

    .section3-root .weather-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.4rem;
    }

    .section3-root .weather-location {
      font-weight: 600;
      font-size: clamp(0.9rem, 1.4vw, 1.1rem);
      letter-spacing: 0.04em;
    }

    .section3-root .weather-date {
      font-size: clamp(0.7rem, 1vw, 0.9rem);
      opacity: 0.8;
      margin-bottom: 0.6rem;
    }

    .section3-root .weather-temp {
      font-size: clamp(2rem, 4vw, 3rem);
      font-weight: 700;
      line-height: 1;
      margin-bottom: 0.6rem;
    }

    .section3-root .meta-date {
      font-variant-numeric: tabular-nums;
    }

    .section3-root .meta-temp {
      font-variant-numeric: tabular-nums;
    }

    .section3-root .weather-meta {
      list-style: none;
      margin: 0;
      padding: 0;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.3rem 0.75rem;
      font-size: clamp(0.68rem, 0.9vw, 0.8rem);
    }

    .section3-root .weather-meta > li {
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
    }

    .section3-root .weather-meta > li > span {
      opacity: 0.8;
    }

    .section3-root .weather-meta ul {
      margin: 0;
      padding: 0;
      list-style: none;
      font-weight: 600;
    }

    .section3-root .weather-meta li li {
      display: inline;
    }

    .section3-root .weather-right {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      height: 100%;
    }

    .section3-root .weather-right-top {
      flex: 1 1 auto;
      background: rgba(0, 0, 0, 0.25);
      border-radius: 0.9rem;
      padding: 0.75rem 0.9rem;
      box-sizing: border-box;
      color: #ffffff;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .section3-root .weather-daily {
      display: grid;
      grid-auto-flow: column;
      grid-auto-columns: minmax(0, 1fr);
      gap: 0.5rem;
      overflow-x: auto;
      padding-bottom: 0.2rem;
    }

    .section3-root .day {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.3rem;
      font-size: clamp(0.7rem, 0.9vw, 0.85rem);
      white-space: nowrap;
      padding: 0.4rem;
      border-radius: 0.5rem;
      background: rgba(0, 0, 0, 0.2);
    }

    .section3-root .day-label {
      opacity: 0.85;
      font-weight: 600;
    }

    .section3-root .day-date {
      opacity: 0.7;
      font-size: 0.85em;
    }

    .section3-root .day-temp-max {
      font-weight: 700;
      font-size: 1.1em;
    }

    .section3-root .day-temp-min {
      opacity: 0.7;
      font-size: 0.9em;
    }

    .section3-root .day-precip {
      opacity: 0.8;
      font-size: 0.85em;
    }

    .section3-root .weather-right-bottom {
      flex: 0 0 auto;
      background: rgba(0, 0, 0, 0.25);
      border-radius: 0.9rem;
      padding: 0.6rem 0.9rem;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .section3-root .weather-query {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .section3-root .query-input {
      flex: 1 1 auto;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.35);
      background: transparent;
      padding: 0.3rem 0.7rem;
      color: #ffffff;
      font: inherit;
      outline: none;
      min-width: 0;
    }

    .section3-root .query-input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    .section3-root .search-button {
      flex: 0 0 auto;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      border-radius: 999px;
      border: 1px solid var(--section-accent, #303539);
      background: var(--section-accent, #303539);
      color: var(--section-bg, #2b402f);
      padding: 0.3rem 0.8rem;
      font: inherit;
      cursor: pointer;
      font-size: clamp(0.7rem, 0.9vw, 0.85rem);
      text-transform: uppercase;
      letter-spacing: 0.07em;
    }

    .section3-root .search-button img {
      max-height: 1.1em;
      width: auto;
    }

    .section3-root .query-button-text {
      white-space: nowrap;
    }

    .section3-root .query-feedback {
      margin-top: 0.25rem;
      font-size: 0.9rem;
      color: #f0f0f0;
      min-height: 1.2em;
    }

    .section3-root .query-feedback.error {
      color: #ffb4a2;
    }

    @media (max-width: 900px) {
      .section3-root .weather-container {
        grid-template-columns: 1fr;
        grid-template-rows: 1.1fr 1fr;
      }
    }

    @media (max-width: 600px) {
      .section3-root {
        padding: 0.75rem;
      }

      .section3-root .weather-left {
        padding: 0.75rem;
      }

      .section3-root .weather-meta {
        grid-template-columns: 1fr;
      }

      .section3-root .query-button-text {
        display: none;
      }

      .section3-root .weather-daily {
        gap: 0.3rem;
      }

      .section3-root .day {
        padding: 0.3rem;
      }
    }
  </style>

  <section class="section-block charcoal-set-in">
    <div class="weather-container container">
      <div class="weather-left">
        <div class="weather-header">
          <div class="weather-location" id="weather-location">
            Peninsula,&nbsp;Ohio
          </div>
        </div>

        <div class="weather-date" id="weather-date">
          <span id="current-date" class="meta-date">Loading date...</span>
        </div>

        <div class="weather-temp" id="weather-temp">
          <span id="current-temp" class="meta-temp">--°</span>
        </div>

        <ul class="weather-meta">
          <li>
            <span>Feels like:</span>
            <ul id="weather-feels" class="feels"><li>Loading...</li></ul>
          </li>
          <li>
            <span>Humidity:</span>
            <ul id="weather-humidity" class="humidity"><li>Loading...</li></ul>
          </li>
          <li>
            <span>Precipitation:</span>
            <ul id="weather-precipitation" class="precipitation"><li>Loading...</li></ul>
          </li>
          <li>
            <span>Sunrise:</span>
            <ul id="weather-sunrise" class="sunrise"><li>Loading...</li></ul>
          </li>
          <li>
            <span>Sunset:</span>
            <ul id="weather-sunset" class="sunset"><li>Loading...</li></ul>
          </li>
          <li>
            <span>Wind:</span>
            <ul id="weather-wind" class="wind"><li>Loading...</li></ul>
          </li>
          <li>
            <span>Pressure:</span>
            <ul id="weather-pressure" class="pressure"><li>Loading...</li></ul>
          </li>
          <li>
            <span>UV:</span>
            <ul id="weather-uv" class="uv"><li>Loading...</li></ul>
          </li>
        </ul>
      </div>

      <div class="weather-right">
        <div class="weather-right-top">
          <div class="weather-daily" id="weather-daily">
            <!-- Daily forecast tiles will be inserted here -->
          </div>
        </div>

        <div class="weather-right-bottom">
          <form class="weather-query" onsubmit="return false;">
            <input
              type="text"
              class="query-input"
              id="query-input"
              placeholder="Try: peninsula, akron, cleveland, cuyahoga"
            >
            <button type="submit" class="search-button">
              <img src="../assets/icons/icon-search.png" alt="Query">
              <span class="query-button-text">Query</span>
            </button>
          </form>
          <div class="query-feedback" id="query-feedback" role="status" aria-live="polite"></div>
        </div>
      </div>
    </div>
  </section>

  <script>
    (function () {
      const root = document.currentScript.closest('.section3-root');
      if (!root) return;

      const WEATHER_API = '/api/weather/daily';

      const FALLBACK_LOCATIONS = {
        peninsula: { lat: 41.241, lon: -81.548, name: 'Peninsula, OH' },
        akron: { lat: 41.0814, lon: -81.519, name: 'Akron, OH' },
        cleveland: { lat: 41.4993, lon: -81.6944, name: 'Cleveland, OH' },
        cuyahoga: { lat: 41.2806, lon: -81.5678, name: 'Cuyahoga Valley National Park' },
      };

      const DEFAULT_COORDS = { lat: 41.241, lon: -81.548, name: 'Cuyahoga Valley' };
      let currentCoords = { ...DEFAULT_COORDS };

      const locationEl = root.querySelector('#weather-location');
      const dateEl = root.querySelector('#weather-date');
      const tempEl = root.querySelector('#weather-temp');
      const feelsEl = root.querySelector('#weather-feels');
      const humidityEl = root.querySelector('#weather-humidity');
      const precipitationEl = root.querySelector('#weather-precipitation');
      const sunriseEl = root.querySelector('#weather-sunrise');
      const sunsetEl = root.querySelector('#weather-sunset');
      const windEl = root.querySelector('#weather-wind');
      const pressureEl = root.querySelector('#weather-pressure');
      const uvEl = root.querySelector('#weather-uv');
      const dailyContainer = root.querySelector('#weather-daily');
      const queryForm = root.querySelector('.weather-query');
      const queryInput = root.querySelector('#query-input');
      const queryFeedback = root.querySelector('#query-feedback');

      const setText = (el, value) => {
        if (el) {
          const listItem = el.querySelector('li');
          if (listItem) {
            listItem.textContent = value;
          } else {
            el.textContent = value;
          }
        }
      };

      const formatDate = (isoDate) => {
        if (!isoDate) return '—';
        const date = new Date(`${isoDate}T00:00:00`);
        return date.toLocaleDateString(undefined, {
          weekday: 'long',
          month: 'long',
          day: 'numeric',
        });
      };

      const formatShortDate = (isoDate) => {
        if (!isoDate) return '—';
        const date = new Date(`${isoDate}T00:00:00`);
        return date.toLocaleDateString(undefined, {
          weekday: 'short',
          month: 'short',
          day: 'numeric',
        });
      };

      const formatTime = (isoDateTime) => {
        if (!isoDateTime) return '—';
        const date = new Date(isoDateTime);
        return date.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
      };

      const formatWind = (speed, direction) => {
        if (speed == null) return '—';
        const dirs = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
        const idx = Math.round(((direction ?? 0) % 360) / 45) % 8;
        return `${Math.round(speed)} km/h ${dirs[idx]}`;
      };

      const showFeedback = (message, isError = false) => {
        if (queryFeedback) {
          queryFeedback.textContent = message;
          queryFeedback.className = isError ? 'query-feedback error' : 'query-feedback';
        }
      };

      const renderDaily = (payload) => {
        const daily = payload?.daily;
        if (!daily || !daily.time || !dailyContainer) return;

        const times = daily.time || [];
        const tempMax = daily.temperature_max || [];
        const tempMin = daily.temperature_min || [];
        const precip = daily.precipitation_sum || [];
        const precipitationUnit = payload.unit_system?.precipitation_sum || 'mm';

        dailyContainer.innerHTML = '';

        const daysToShow = Math.min(7, times.length);
        for (let i = 0; i < daysToShow; i++) {
          const tile = document.createElement('div');
          tile.className = 'day';

          const label = document.createElement('div');
          label.className = 'day-label';
          if (i === 0) {
            label.textContent = 'Today';
          } else {
            const date = new Date(`${times[i]}T00:00:00`);
            label.textContent = date.toLocaleDateString(undefined, { weekday: 'short' });
          }

          const dateLabel = document.createElement('div');
          dateLabel.className = 'day-date';
          dateLabel.textContent = formatShortDate(times[i]);

          const tempMaxEl = document.createElement('div');
          tempMaxEl.className = 'day-temp-max';
          tempMaxEl.textContent = tempMax[i] != null ? `${Math.round(tempMax[i])}°` : '—';

          const tempMinEl = document.createElement('div');
          tempMinEl.className = 'day-temp-min';
          tempMinEl.textContent = tempMin[i] != null ? `${Math.round(tempMin[i])}°` : '—';

          const precipEl = document.createElement('div');
          precipEl.className = 'day-precip';
          if (precip[i] != null && precip[i] > 0) {
            precipEl.textContent = `${Math.round(precip[i] * 10) / 10}${precipitationUnit}`;
          } else {
            precipEl.textContent = '—';
          }

          tile.appendChild(label);
          tile.appendChild(dateLabel);
          tile.appendChild(tempMaxEl);
          tile.appendChild(tempMinEl);
          tile.appendChild(precipEl);
          dailyContainer.appendChild(tile);
        }
      };

      const updateWeatherDisplay = (payload, overrideLabel) => {
        if (!payload || !payload.daily) return;

        const daily = payload.daily;
        const precipitationUnit = payload.unit_system?.precipitation_sum || 'mm';
        const firstDay = {
          date: daily.time?.[0],
          tempMax: daily.temperature_max?.[0],
          tempMean: daily.temperature_mean?.[0],
          apparentMax: daily.apparent_temperature_max?.[0],
          sunrise: daily.sunrise?.[0],
          sunset: daily.sunset?.[0],
          windspeed: daily.windspeed_max?.[0],
          windDirection: daily.winddirection_dominant?.[0],
          uvIndex: daily.uv_index_max?.[0],
          precipitation: daily.precipitation_sum?.[0],
        };

        setText(
          locationEl,
          overrideLabel || payload.timezone?.replace(/_/g, ' ') || 'Local forecast'
        );
        setText(dateEl, formatDate(firstDay.date));
        setText(tempEl, firstDay.tempMax != null ? `${Math.round(firstDay.tempMax)}°` : '—');
        setText(feelsEl, firstDay.apparentMax != null ? `${Math.round(firstDay.apparentMax)}°` : '—');
        setText(humidityEl, '—');
        setText(
          precipitationEl,
          firstDay.precipitation != null
            ? `${Math.round(firstDay.precipitation * 10) / 10} ${precipitationUnit}`
            : '—'
        );
        setText(sunriseEl, formatTime(firstDay.sunrise));
        setText(sunsetEl, formatTime(firstDay.sunset));
        setText(windEl, formatWind(firstDay.windspeed, firstDay.windDirection));
        setText(pressureEl, '—');
        setText(uvEl, firstDay.uvIndex != null ? `${firstDay.uvIndex} UV` : '—');

        renderDaily(payload);
      };

      const fetchWeather = (coords = currentCoords, label = coords.name) => {
        const url = `${WEATHER_API}?lat=${coords.lat}&lon=${coords.lon}&days=7`;

        setText(locationEl, label || 'Loading forecast…');
        showFeedback('Loading weather data…');

        fetch(url)
          .then((resp) => {
            if (!resp.ok) {
              return resp.json().then((errorData) => {
                throw new Error(errorData.message || errorData.error || `Weather API error: ${resp.status}`);
              }).catch(() => {
                throw new Error(`Weather API error: ${resp.status}`);
              });
            }
            return resp.json();
          })
          .then((data) => {
            updateWeatherDisplay(data, label);
            showFeedback(`Showing weather for ${label}.`);
          })
          .catch((err) => {
            console.error('Weather fetch error:', err);
            setText(locationEl, 'Weather unavailable');
            setText(dateEl, formatDate(new Date().toISOString().slice(0, 10)));
            setText(tempEl, '—');
            showFeedback(err.message || 'Unable to load weather data.', true);
          });
      };

      const resolveQueryToCoords = (query) => {
        const trimmed = query.trim();
        if (!trimmed) {
          return Promise.reject(new Error('Please enter a location.'));
        }

        const normalized = trimmed.toLowerCase();
        if (FALLBACK_LOCATIONS[normalized]) {
          return Promise.resolve(FALLBACK_LOCATIONS[normalized]);
        }

        const availableLocations = Object.keys(FALLBACK_LOCATIONS).join(', ');
        return Promise.reject(
          new Error(`Location not found. Try: ${availableLocations}`)
        );
      };

      if (queryForm && queryInput) {
        queryForm.addEventListener('submit', (event) => {
          event.preventDefault();
          const queryValue = queryInput.value.trim();

          if (!queryValue) {
            showFeedback('Please enter a location.', true);
            return;
          }

          showFeedback('Looking up location…');

          resolveQueryToCoords(queryValue)
            .then((coords) => {
              currentCoords = { ...coords };
              showFeedback(`Showing weather for ${coords.name || queryValue}.`);
              fetchWeather(currentCoords, coords.name || queryValue);
            })
            .catch((err) => {
              console.error('Location resolution error:', err);
              showFeedback(err.message || 'Unable to find that location.', true);
              queryInput.focus();
            });
        });
      }

      fetchWeather();
    })();
  </script>
</div>
